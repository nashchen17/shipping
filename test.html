<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>搜尋功能測試</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 20px; border: 1px solid #ccc; }
        #searchResults div { padding: 10px; margin: 5px 0; border: 1px solid #ddd; }
        button { padding: 5px 10px; margin: 5px; }
    </style>
</head>
<body>
    <h1>搜尋功能測試</h1>
    
    <div class="test-section">
        <h3>測試搜尋功能</h3>
        <input type="text" id="productSearch" placeholder="輸入搜尋關鍵字" style="width: 300px; padding: 5px;" />
        <button id="searchBtn">搜尋</button>
        <button id="loadTestData">載入測試資料</button>
        <div id="searchResults" style="margin-top: 10px;"></div>
    </div>
    
    <div class="test-section">
        <h3>控制台輸出</h3>
        <div id="console" style="background: #f0f0f0; padding: 10px; height: 200px; overflow-y: auto;"></div>
    </div>

    <script>
        // 模擬console.log輸出到頁面
        const originalLog = console.log;
        console.log = function(...args) {
            originalLog.apply(console, args);
            const consoleDiv = document.getElementById('console');
            consoleDiv.innerHTML += args.join(' ') + '<br>';
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        };

        // 測試資料
        let excelData = [];
        
        document.getElementById('loadTestData').addEventListener('click', function() {
            excelData = [
                { dwg: 'ABC123', nc: 'NC001', unitPrice: 100, poNumber: 'PO001', shipmentNumber: '', remark: '' },
                { dwg: 'XYZ456', nc: 'NC002', unitPrice: 200, poNumber: 'PO002', shipmentNumber: '', remark: '' },
                { dwg: 'TEST789', nc: 'NC003', unitPrice: 300, poNumber: 'PO003', shipmentNumber: '', remark: '' }
            ];
            console.log('測試資料已載入:', excelData.length, '筆');
        });

        // 複製搜尋相關函數
        function smartSearch(data, searchTerm) {
            const results = [];
            const cleanSearchTerm = searchTerm.trim().toLowerCase();
            
            const isNumberOnly = /^\d+$/.test(searchTerm.trim());
            
            for (let item of data) {
                if ((item.shipmentNumber && item.shipmentNumber.trim() !== '') || item.remark === '結案') {
                    continue;
                }
                
                const cleanDwg = item.dwg.toLowerCase();
                let score = 0;
                let matchType = '';
                
                if (isNumberOnly) {
                    if (cleanDwg === cleanSearchTerm) {
                        score = 100;
                        matchType = '完全匹配';
                    } else if (cleanDwg.startsWith(cleanSearchTerm)) {
                        score = 95;
                        matchType = '開頭匹配';
                    } else if (cleanDwg.includes(cleanSearchTerm)) {
                        score = 85;
                        matchType = '包含匹配';
                    } else {
                        const dwgNumbers = item.dwg.match(/\d+/g);
                        if (dwgNumbers) {
                            for (let num of dwgNumbers) {
                                if (num.includes(searchTerm)) {
                                    score = Math.max(score, 75);
                                    matchType = '數字匹配';
                                }
                            }
                        }
                    }
                    
                    if (score >= 60) {
                        results.push({
                            ...item,
                            similarity: Math.round(score),
                            matchType: matchType
                        });
                    }
                } else {
                    if (cleanDwg === cleanSearchTerm) {
                        results.push({
                            ...item,
                            similarity: 100,
                            matchType: '完全匹配'
                        });
                    }
                }
            }
            
            return results.sort((a, b) => {
                if (b.similarity === a.similarity) {
                    return a.dwg.localeCompare(b.dwg);
                }
                return b.similarity - a.similarity;
            });
        }

        function searchProducts() {
            console.log('searchProducts函數被調用');
            const searchTerm = document.getElementById('productSearch').value.trim();
            const resultsDiv = document.getElementById('searchResults');
            
            console.log('搜尋關鍵字:', searchTerm);
            console.log('Excel資料長度:', excelData.length);
            
            if (!searchTerm) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            if (excelData.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: red;">請先上傳Excel檔案</div>';
                return;
            }
            
            const filteredData = smartSearch(excelData, searchTerm);
            console.log('搜尋結果數量:', filteredData.length);
            
            if (filteredData.length === 0) {
                resultsDiv.innerHTML = '<div style="padding: 10px; color: gray;">找不到相符的產品</div>';
                return;
            }
            
            resultsDiv.innerHTML = '';
            
            filteredData.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.innerHTML = `
                    <strong>${item.dwg}</strong>
                    <span style="color: #666; font-size: 12px;">
                        (${item.matchType}: ${item.similarity}%)
                    </span><br>
                    NC: ${item.nc} | 單價: $${item.unitPrice} | 採購單號: ${item.poNumber}
                `;
                resultsDiv.appendChild(itemDiv);
            });
            
            console.log('搜尋結果已顯示');
        }

        // 綁定事件
        document.getElementById('productSearch').addEventListener('input', searchProducts);
        document.getElementById('searchBtn').addEventListener('click', searchProducts);
        
        console.log('事件監聽器已綁定');
    </script>
</body>
</html>